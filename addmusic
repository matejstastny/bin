#!/bin/bash

# --------------------------------------------------------------------------------------------
# addmusic - Add songs to Apple Music playlist from a text file
# --------------------------------------------------------------------------------------------
# Author: Matej Stastny
# Date: 2025-09-26 (YYYY-MM-DD)
# License: MIT
# Link: https://github.com/matejstastny/bin
# --------------------------------------------------------------------------------------------
# Description:
# This script reads a list of song names from a text file, searches for them using Apple's
# public search API, and adds them to a specified Apple Music playlist
# --------------------------------------------------------------------------------------------

if [[ $# -ne 2 ]]; then
    echo "‚ùå Usage: $0 <songs_file> <playlist_name>"
    exit 1
fi

SONGS_FILE="$1"
PLAYLIST_NAME="$2"

if [[ ! -f "$SONGS_FILE" ]]; then
    echo "‚ùå Error: File '$SONGS_FILE' not found."
    exit 1
fi

echo "üéµ Starting to add songs to '$PLAYLIST_NAME' from '$SONGS_FILE'..."

while IFS= read -r SONG; do
    if [[ -n "$SONG" ]]; then
        echo "üîç Searching for: $SONG..."

        # Use Apple's public search API
        JSON_RESULT=$(curl -s "https://itunes.apple.com/search?term=$(echo "$SONG" | sed 's/ /+/g')&limit=1&media=music")

        TRACK_ID=$(echo "$JSON_RESULT" | grep -o '"trackId":[0-9]*' | head -n1 | awk -F: '{print $2}')
        TRACK_NAME=$(echo "$JSON_RESULT" | grep -o '"trackName":"[^"]*' | sed 's/"trackName":"//' | head -n1)
        TRACK_ARTIST=$(echo "$JSON_RESULT" | grep -o '"artistName":"[^"]*' | sed 's/"artistName":"//' | head -n1)

        if [[ -n "$TRACK_ID" ]]; then
            echo "‚úÖ Found: $TRACK_NAME by $TRACK_ARTIST"

            # Open Apple Music link to add to the library
            MUSIC_URL="https://music.apple.com/us/song/$TRACK_ID"
            echo "üåê Opening: $MUSIC_URL"
            open "$MUSIC_URL"

            # Wait a few seconds to ensure it's added to the library
            sleep 3

            # Now add it to the playlist using AppleScript
            osascript <<EOF
      tell application "Music"
        -- Ensure playlist exists
        if not (exists playlist "$PLAYLIST_NAME") then
          make new playlist with properties {name:"$PLAYLIST_NAME"}
        end if

        -- Find the song in the library (added from the web link)
        set foundTrack to (every track of library playlist 1 whose name is "$TRACK_NAME")

        if (count of foundTrack) > 0 then
          add item 1 of foundTrack to playlist "$PLAYLIST_NAME"
          return "‚úÖ Added to playlist: $TRACK_NAME"
        else
          return "‚ö†Ô∏è Could not find track in library after adding."
        end if
      end tell
EOF
        else
            echo "‚ö†Ô∏è Not found: $SONG"
        fi
    fi
done <"$SONGS_FILE"

echo "üéâ Done! All songs processed."
